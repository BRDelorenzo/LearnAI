<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LearnAI</title>
<style>
  :root{
    --bg:#0b0b0d; --panel:#111114; --muted:#9aa0a6; --text:#e8eaed;
    --chip:#1a1b1f; --chipText:#e8eaed; --primary:#6d6bf9; --accent:#22c55e;
    --danger:#ef4444; --border:#24252a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}
  .app{display:grid;grid-template-columns:280px 1fr;min-height:100dvh}
  /* sidebar */
  .sidebar{background:#0f1013;border-right:1px solid var(--border);padding:14px;display:flex;flex-direction:column;gap:12px}
  .brand{display:flex;align-items:center;gap:10px}
  .hamb{display:none}
  .brand .logo{width:26px;height:26px;border-radius:6px;background:linear-gradient(135deg,#7c3aed,#22d3ee);display:inline-block}
  .brand strong{font-weight:600}
  .upgrade{align-self:center;background:#2a2378;color:#c7c5ff;border:0;padding:8px 14px;border-radius:999px}
  .hist-title{opacity:.8;margin:8px 0 4px 2px;font-size:.9rem}
  .hist{overflow:auto;flex:1;display:flex;flex-direction:column;gap:6px}
  .hist button{width:100%;text-align:left;background:transparent;border:1px solid var(--border);color:var(--text);
    padding:10px;border-radius:10px;opacity:.9;cursor:pointer}
  .hist button:hover{background:#15161a}
  .hist .empty{color:var(--muted);font-size:.9rem;padding:10px}
  /* main */
  .main{display:grid;grid-template-rows:auto 1fr auto;min-height:100dvh}
  .topbar{display:flex;align-items:center;gap:8px;justify-content:center;padding:10px;position:sticky;top:0;background:linear-gradient(#0b0b0de6,#0b0b0de6)}
  .topbar .upgrade{background:#2a2378}
  .chat{padding:16px;display:flex;flex-direction:column;gap:14px;overflow:auto}
  .msg{max-width:720px;margin:0 auto;border:1px solid var(--border);background:var(--panel);border-radius:16px;padding:14px 16px;line-height:1.45}
  .msg.me{border-color:#2c2e33;background:#14151a}
  .chips{position:fixed;left:0;right:0;bottom:86px;display:flex;gap:12px;justify-content:center;flex-wrap:wrap;padding:0 16px}
  .chip{background:var(--chip);color:var(--chipText);border:1px solid var(--border);border-radius:16px;padding:12px 14px;min-width:180px;max-width:300px}
  .chip b{display:block;margin-bottom:6px}
  /* composer */
  .composer-wrap{position:sticky;bottom:0;background:linear-gradient(180deg,transparent,#0b0b0d 40% 100%),#0b0b0d;padding:10px 12px}
  .composer{max-width:920px;margin:0 auto;display:grid;grid-template-columns:auto 1fr auto auto;gap:10px;align-items:center}
  .btn{height:48px;min-width:48px;border-radius:14px;border:1px solid var(--border);background:#14151a;color:var(--text);display:inline-grid;place-items:center;cursor:pointer}
  .btn:hover{background:#17181d}
  .plus{font-size:24px}
  .input{height:48px;border-radius:14px;border:1px solid var(--border);background:#14151a;color:var(--text);padding:0 14px;width:100%}
  .send{min-width:48px}
  .mic{position:relative;overflow:hidden}
  .mic.rec{outline:2px solid var(--accent);box-shadow:0 0 0 4px #22c55e1f}
  .vu{position:absolute;inset:0;border-radius:14px;pointer-events:none}
  .vu .fill{position:absolute;left:0;bottom:0;height:100%;width:0%;background:linear-gradient(90deg,#60a5fa,#22c55e);opacity:.25}
  .status{max-width:920px;margin:6px auto 0;color:var(--muted);font-size:.9rem;padding:0 4px}
  /* mobile */
  @media (max-width:900px){
    .app{grid-template-columns:1fr}
    .sidebar{position:fixed;inset:0 30% 0 0;z-index:30;transform:translateX(-105%);transition:transform .2s ease}
    .sidebar.open{transform:translateX(0)}
    .hamb{display:inline-grid;place-items:center;width:42px;height:42px;border-radius:10px;border:1px solid var(--border);background:#14151a;cursor:pointer}
    .topbar{justify-content:space-between;padding:10px 12px}
  }
</style>
</head>
<body>
<div class="app">
  <!-- SIDEBAR / HIST√ìRICO -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <span class="logo"></span>
      <strong>LearnAI</strong>
    </div>
    <div class="hist-title">Hist√≥rico</div>
    <div class="hist" id="historyList">
      <div class="empty">Sem conversas ainda.</div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="topbar">
      <button class="hamb" id="hamb">‚ò∞</button>
      <span style="width:42px"></span>
    </div>

    <!-- CHAT MESSAGES -->
    <section class="chat" id="chat"></section>

    <!-- SUGEST√ïES -->

    <!-- COMPOSER -->
    <div class="composer-wrap">
      <div class="composer">
        <button class="btn plus" id="addBtn">+</button>
        <input class="input" id="textInput" placeholder="Pergunte alguma coisa" />
        <button class="btn mic" id="micBtn" aria-label="Gravar √°udio">
          üéôÔ∏è
          <div class="vu"><div class="fill" id="vuFill"></div></div>
        </button>
        <button class="btn send" id="sendBtn" aria-label="Enviar">‚û§</button>
      </div>
      <div class="status" id="status">Aguardando‚Ä¶</div>
    </div>
  </main>
</div>

<script>
/** -------------------- State / DOM -------------------- **/
const chatEl = document.getElementById('chat');
const textInput = document.getElementById('textInput');
const sendBtn = document.getElementById('sendBtn');
const micBtn = document.getElementById('micBtn');
const vuFill = document.getElementById('vuFill');
const statusEl = document.getElementById('status');
const chipsEl = document.getElementById('chips');
const historyList = document.getElementById('historyList');
const sidebar = document.getElementById('sidebar');
const hamb = document.getElementById('hamb');

let mediaRecorder, chunks = [], mime = '';
let audioContext, analyser, monitorInterval, rmsSmooth = 0;
let currentThreadId = loadLastThreadId();

/** -------------------- UI helpers -------------------- **/
function addMsg(text, who='me'){
  const div = document.createElement('div');
  div.className = 'msg ' + (who === 'me' ? 'me' : 'bot');
  div.textContent = text;
  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
}
function setStatus(msg){ statusEl.textContent = msg; }
function fmtTitle(s){ return (s || 'Sem t√≠tulo').slice(0, 40); }

/** -------------------- Hist√≥rico (localStorage) -------------------- **/
function loadThreads(){ return JSON.parse(localStorage.getItem('threads') || '{}'); }
function saveThreads(obj){ localStorage.setItem('threads', JSON.stringify(obj)); }
function loadLastThreadId(){ return localStorage.getItem('lastThreadId') || null; }
function setLastThreadId(id){ localStorage.setItem('lastThreadId', id); }
function newThread(title){
  const id = Date.now().toString(36);
  const threads = loadThreads();
  threads[id] = { id, title, messages: [] };
  saveThreads(threads); setLastThreadId(id);
  renderHistory(); return id;
}
function pushMsgToThread(id, msg){
  const threads = loadThreads();
  if(!threads[id]) return;
  threads[id].messages.push(msg);
  if(!threads[id].title && msg.role==='user') threads[id].title = fmtTitle(msg.text);
  saveThreads(threads); renderHistory();
}
function renderHistory(){
  const threads = loadThreads();
  historyList.innerHTML = '';
  const ids = Object.keys(threads).sort((a,b)=> (threads[b].id-threads[a].id));
  if(!ids.length){ historyList.innerHTML = '<div class="empty">Sem conversas ainda.</div>'; return; }
  ids.forEach(id=>{
    const b = document.createElement('button');
    b.textContent = fmtTitle(threads[id].title || 'Sem t√≠tulo');
    b.onclick = ()=> { openThread(id); };
    historyList.appendChild(b);
  });
}
function openThread(id){
  const threads = loadThreads();
  const t = threads[id]; if(!t) return;
  currentThreadId = id; setLastThreadId(id);
  chatEl.innerHTML=''; t.messages.forEach(m=> addMsg(m.text, m.role==='user'?'me':'bot'));
  setStatus('Conversando‚Ä¶');
  if (window.innerWidth < 900) sidebar.classList.remove('open');
}
renderHistory();
if(!currentThreadId){ currentThreadId = newThread(''); }
else { openThread(currentThreadId); }

/** -------------------- Chips -------------------- **/
chipsEl.addEventListener('click', (e)=>{
  const chip = e.target.closest('.chip'); if(!chip) return;
  const text = chip.querySelector('b').textContent + ' ' + chip.querySelector('div').textContent;
  textInput.value = text;
  textInput.focus();
});

/** -------------------- Sidebar mobile -------------------- **/
hamb?.addEventListener('click', ()=> sidebar.classList.toggle('open'));

/** -------------------- Text Send -------------------- **/
sendBtn.addEventListener('click', sendText);
textInput.addEventListener('keydown', (e)=> {
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendText(); }
});

async function sendText(){
  const text = textInput.value.trim();
  if(!text) return;
  addMsg(text, 'me');
  pushMsgToThread(currentThreadId, { role:'user', text });
  textInput.value = '';
  chipsEl.style.display = 'none';
  setStatus('‚úâÔ∏è Enviando texto‚Ä¶');

  try{
    // rota opcional do backend; veja snippet abaixo
    const res = await fetch('/chat', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text }) });
    if(!res.ok){
      addMsg('‚ö†Ô∏è Backend /chat n√£o encontrado. Resposta simulada no front.', 'bot');
      setStatus('Pronto.');
      return;
    }
    const data = await res.json();
    const reply = data.reply || '(sem resposta)';
    addMsg(reply, 'bot');
    pushMsgToThread(currentThreadId, { role:'assistant', text: reply });
    setStatus('Pronto.');
  }catch(err){
    console.error(err);
    addMsg('‚ùå Erro ao enviar texto: ' + err.message, 'bot');
    setStatus('Erro.');
  }
}

/** -------------------- Captura de √°udio (auto-stop) -------------------- **/
const SILENCE = { TH: 0.01, DUR: 2000, PROBE: 100, VU_SMOOTH: 0.85, VU_GAIN: 35 };

micBtn.addEventListener('click', ()=> {
  if (mediaRecorder && mediaRecorder.state === 'recording') {
    stopRecording('Parando‚Ä¶');
  } else {
    startRecording();
  }
});

function pickMime(){
  const c = ['audio/webm;codecs=opus','audio/webm','audio/ogg;codecs=opus','audio/ogg','audio/mp4;codecs=alac','audio/mp4','audio/wav'];
  for(const m of c){ if(MediaRecorder.isTypeSupported?.(m)) return m; }
  return '';
}

async function startRecording(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true } });
    mime = pickMime();
    mediaRecorder = mime ? new MediaRecorder(stream, { mimeType:mime }) : new MediaRecorder(stream);
    chunks = [];
    mediaRecorder.ondataavailable = e=> e.data?.size && chunks.push(e.data);
    mediaRecorder.onstop = onStop;
    mediaRecorder.start();
    micBtn.classList.add('rec');
    setStatus('üé§ Gravando‚Ä¶ (para autom√°tico ao ficar em sil√™ncio)');
    startSilenceDetection(stream);
  }catch(err){
    console.error(err);
    setStatus('‚ùå Erro ao acessar microfone.');
  }
}

function startSilenceDetection(stream){
  audioContext = new (window.AudioContext||window.webkitAudioContext)();
  const src = audioContext.createMediaStreamSource(stream);
  analyser = audioContext.createAnalyser(); analyser.fftSize = 2048;
  src.connect(analyser);
  const buf = new Float32Array(analyser.fftSize);
  let since = performance.now();

  monitorInterval = setInterval(()=>{
    analyser.getFloatTimeDomainData(buf);
    let sum=0; for(let i=0;i<buf.length;i++) sum += buf[i]*buf[i];
    const rms = Math.sqrt(sum/buf.length);

    // VU
    rmsSmooth = SILENCE.VU_SMOOTH * rmsSmooth + (1-SILENCE.VU_SMOOTH)*rms;
    const pct = Math.max(0, Math.min(100, rmsSmooth*100*SILENCE.VU_GAIN));
    vuFill.style.width = pct + '%';

    if(rms < SILENCE.TH){
      if(performance.now()-since >= SILENCE.DUR) stopRecording('üõë Sil√™ncio detectado. Parando‚Ä¶');
    }else{
      since = performance.now();
    }
  }, SILENCE.PROBE);
}

function stopRecording(msg='Parando‚Ä¶'){
  try{
    if(mediaRecorder?.state==='recording'){ mediaRecorder.stop(); }
    mediaRecorder?.stream?.getTracks().forEach(t=> t.stop());
  }catch{}
  micBtn.classList.remove('rec');
  setStatus(msg);
  clearInterval(monitorInterval); monitorInterval=null;
  try{ audioContext?.close(); }catch{}
  analyser=null; vuFill.style.width='0%'; rmsSmooth=0;
}

async function onStop(){
  const blob = new Blob(chunks, { type: mime || 'audio/webm' });
  const ext = blob.type.includes('ogg')?'ogg':blob.type.includes('webm')?'webm':blob.type.includes('mp4')?'m4a':'wav';
  const form = new FormData(); form.append('file', blob, 'gravacao.'+ext);

  addMsg('üéôÔ∏è [√°udio enviado]', 'me');
  pushMsgToThread(currentThreadId, { role:'user', text:'[√°udio]' });

  setStatus('‚è≥ Transcrevendo‚Ä¶');
  try{
    const res = await fetch('/transcrever', { method:'POST', body: form });
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    const text = data.transcricao || '(sem texto)';
    addMsg(text, 'bot');
    pushMsgToThread(currentThreadId, { role:'assistant', text });
    setStatus('Pronto.');
  }catch(err){
    console.error(err);
    addMsg('‚ùå Erro ao transcrever: '+err.message, 'bot');
    setStatus('Erro.');
  }
}
</script>
</body>
</html>
